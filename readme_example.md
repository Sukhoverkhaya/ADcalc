# Инструкция по использованию конструктора заключений "ECG-helper"

## Интерфейс

Открыв приложение, пользователь видит три окна - ***"Меню выбора"***, ***"Выбор фраз"*** и ***"Заключение"***. 

### Меню выбора

 ***"Меню выбора"*** представляет собой заголовки вкладок, содержимое которых будет отображаться в соседнем окне. 
Переключение между этими вкладками будет происходить автоматически (при совершении выбора в одной - открывается следующая),
но при этом остаётся возможность переключать их вручную в произвольном порядке.

### Выбор фраз

Окно ***"Выбор фраз"*** включает в себя три кнопки: ***"Продолжить с новым ритмом"***, ***"Новое заключение"***, ***"Настройки"***; а также здесь 
находятся все фразы, входящие во вкладку, открытую в ***"Меню выбора"***. 

Кнопка ***"Продолжить с новым ритмом"*** позволяет пользователю продолжить заполнение текущего заключения, но уже с новыми 
данными (все запрещающие комбинации сбрасываются. Новые запрещающие комбинации не будут влиять на часть заключения, 
сформированную в предыдущем цикле). ***"Новое заключение"*** очищает уже написанное заключение и стирает все существующие 
запреты, возникшие по ходу составления прошлого заключения. В меню ***"Настройки"*** можно выбрать цветовую тему.

Фразы, при нажатии на них добавляются вниз заключения. Слева от каждого предложения 
находится маркер-подсказка, наведясь на который, можно увидеть, какая фраза будет добавлена в заключение, при нажатии соответствующей кнопки.
Также, как было сказано ранее, осуществляется автоматический переход из одного раздела в другой, но при этом есть возможность этого избежать - с зажатой клавишей `Ctrl` фразы будут добавляться в одну строку, без точки в конце, а также не будет происходить перехода в другой раздел. После отжатия `Ctrl` поставится точка и переключится раздел. 

При выборе в ***"Меню"*** вкладки ***"Пользовательские фразы"*** откроется другое меню, включающее в себя поле для ввода новой фразы, кнопку
***"Сохранить фразу"***. 
При добавлении фразы она появится над ранее описанным полем, также слева от неё будет находиться кнопка ***"X"***, позволяющаяя удалить эту фразу. 
Если закрыть программу и открыть её вновь, то все добавленные в прошлую сессию фразы останутся и будут доступны для выбора. 

### Заключение

В окне ***"Заключение"*** располагается три кнопки: ***"Очистить"***, ***"Сохранить в историю"*** и ***"Загрузить историю"***; вкладки с текущим 
и сохранёнными в истории заключениями; Поле с текстом для заключения (текущего или сохранённого). 
Кнопка ***"Очистить"*** очищает поле с текущим заключением, стирая текст, но оставляя все имеющиеся запреты. 
***"Сохранить в историю"*** сохраняет текущее заключение в файл с историей, а так же открывает его во вкладке рядом (создаёт 
новую, если вкладок меньше 10, либо встаёт на место самой старой из них). ***"Загрузить историю"*** читает ранее сохранённую 
историю из отведённого ей файла (если ранее историю ничего не созранялось - ничего не произойдёт) и открывает её во 
вкладках рядом по правилам, описанным ранее.

Поле текущего заключения автоматически дополняется выбранными в предыдущем окне фразами, а также доступно к 
самостоятельному редактированию. Если же выбрано одно из сохранённых заключений, то из него можно только копировать 
текст - к редактированию оно не будет доступно.
Помимо всего прочего, при открытии вкладки из истории становится доступным заменить ей имя, введя его в поле в самом низу 
и нажав на кнопку "Сохранить новое имя вкладки".

## Структура текстового файла

### В общем случае документ-источник выглядит следующим образом:
```
<Ключ группы>: <имя группы> | <шаблон группы>
  <фраза> | <шаблон фразы> : <флаги, запрещающие фразу> : <запреты, создающиеся фразой>
  <фраза> | <шаблон фразы> : <флаги, запрещающие фразу> : <запреты, создающиеся фразой>
  ...     
#
<Ключ группы>: <имя группы> | <шаблон группы>
  <фраза> | <шаблон фразы> : <флаги, запрещающие фразу> : <запреты, создающиеся фразой>
  ...     
# 
...   
#
```

### Пример текстового файла:

```
Rythm: Ритмы | Выбран ритм - $
  Синусовый ритм : B, C, D, E, F : A
  Фибрилляция предсердий | Особый ритм - $ : A, C, D, E, F : B
  Синусовая аритмия : B, C, D, E, F : A
#
SaAb: СА и АВ блокады
  Атриовентрикулярная блокада I степени : C, E, F
  Укорочен интервал PQ : B, C, D, F
#
```

### Система запретов

Из-за того, что некоторые варианты в заключении могут противоречить друг-другу, существует система запретов: 
каждая фраза может быть запрещена какой-то другой, либо запрещать сама. За эти комбинации отвечают латинские буквы-флаги, 
то есть, если ранее была выбрана фраза, выглядящая следующим образом:

```
<фраза_1> : <...> : A
```

то вдальнейшем не будут отображены фразы, выглядищие так:

```
<фраза_N> : A, <...> : <...>
```

Уже существующие запреты снимаются кнопками "Продоллжить с новым ритмом" (при этом существующий текст в "Заключении" остаётся) и "Новое заключение" (при этом стираются и запреты, и уже созданный текст).

### Система "Шаблонов"

Шаблон представляет собой некоторый текст, состоящий из обычных слов - `ритм`, ключей - `$keyX`, подстрок, находящихся в фигурных скобках -`{текст вложенного шаблона...}`. Таким образом, при выполнении определённых условий, описанных ниже, текст добавляемый в заключение не обязательно будет совпадать с именем выбранного элемента, а соответствовать его шаблону.


#### Символы $ и {}


$ означает, что в этом месте мы хотим обратиться к ключу, при этом `$key1` - обращение к ключу `key1`, а `$` - обращение к ключу текущей группы/фразы.  Ключи нужны для того, чтобы идентифицировать категории между собой. Таким образом, эта конструкция позволяет объединять в одну фразу элементы, выбранные в разных разделах, поэтому у каждого раздела должен быть свой уникальный ключ. 

В конечном варианте фразы на место ключа подставится имя элемента, выбранного в группе, имеющей данный ключ. Если такой элемент не выбран - вместо
ключа ничего не подставляется, а он просто стирается. 

Исключением являются ключи, прописанные в фигурных скобках `{<...> $key1 <...>}` - такая конструкция будет подставлена в итоговую фразу ТОЛЬКО тогда, когда найдутся ВСЕ ключи, объявленные у неё внутри. В противном случае, в итоговой фразе будет всё, за исключением содержимого этих скобок. Фигурные скобки можно вкладывать друг в друга - все правила продолжают работать также. 


#### Приоритеты и пустые шаблоны


Если и у элемента, и у группы, включающей его, есть шаблоны, то будет спользоваться шаблон элемента. Сами по себе шаблоны элементов и категорий работают полностью одинаково, разница лишь в приоритетах.

Если группа в текстовом документе записана следующим образом: `SaAb: СА и АВ блокады`, то будет считаться, что у этой группы отсутствует шаблон, то есть, при выборе элемента из этой группы, в конечной фразе будет находиться либо текст по шаблону этого элемента, либо имя самого элемента.

Если группа в текстовом документе записана следующим образом: `SaAb: СА и АВ блокады |`, то будет считаться, что у фразы пустой шаблон, то есть, при выборе любого элемента, у которого отсутствует собственный шаблон, не будет выведено ничего в конечное заключение. 

#### Пример работы шаблона:

Пусть есть следующий текст в исходном файле:
```
key1: Группа без шаблона
  текст 1 : <...> : <...>
  текст 2 | Это $ : <...> : <...>  
  текст 3 | : <...> : <...>
#
key2: Группа с пустым шаблоном |
  текст 4 : <...> : <...>
  текст 5 | Вы выбрали $: <...> : <...>
#
key3: Группа с шаблоном | Ваш выборы : { $key1 } {, $key2 } {, $key3 }
  текст 6 : <...> : <...>
  текст 7 | { меня будет видно только вместе с $key1 } : <...> : <...>
#
```

Тогда при последовательном выборе следующих элементов будет следующий результат:

Ввод  : `текст 1 + текст 3 + текст 5`
Вывод : 

```
текст 1
Вы выбрали текст 5
```

Ввод  : `текст 1 + текст 2 + текст 4 + текст 6` 
Вывод : 

```
текст 1
Это текст 2
Ваш выбор: текст 2, текст 4, текст 6
```

Ввод  : `текст 4 + текст 7` 
Вывод : ` `

Ввод  : `текст 2 + текст 7` 
Вывод : 

```
Это текст 2
меня будет видно только вместе с текст 2
```
